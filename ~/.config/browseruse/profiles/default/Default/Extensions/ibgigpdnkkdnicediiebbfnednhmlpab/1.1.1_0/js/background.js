(()=>{var e={hPort:null,basicInfo:null,extPoctInfo:{bPCMgrInstall:!1,bExtPoctSwitch:!1,bTrayRunning:!1},defenseCount:{todayRiskCount:0,todayCount:0,totalRiskCount:0},safeUrl:"https://sdi.3g.qq.com/v/2022092615014911838",queryCssResponseMap:{},popupCallback:null,startUrlCallback:null,popupQueryCallback:null,jsQueryMap:{},init:function(){if(e.probeConnect(),null!=e.hPort){e.extPoctInfo.bPCMgrInstall=!0;e.hPort.postMessage(JSON.stringify({CMD:"StartUpReport",VERSION:3,TYPE:1,X64CHROME:!1})),e.getKidsPoctStatus(),setInterval(e.getKidsPoctStatus,3e4)}else e.extPoctInfo.bPCMgrInstall=!1;setInterval(e.probeConnect,5e3)},isInPoct:function(){return!!(e.extPoctInfo.bPCMgrInstall&&e.extPoctInfo.bKidsPoctSwitch&&e.extPoctInfo.bTrayRunning)},getKidsPoctStatus:function(){if(e.hPort){e.hPort.postMessage(JSON.stringify({CMD:"GetExtPoctStatus"}))}},onDisconnected:function(){e.hPort=null,e.extPoctInfo.bPCMgrInstall=!1},onNativeMessage:function(t){e.handleMsgFromNative(t)},connect:function(){var t=chrome.runtime.connectNative("com.qq.qqpcmgr");return null!=t?(t.onMessage.addListener(e.onNativeMessage),t.onDisconnect.addListener(e.onDisconnected),t):null},probeConnect:function(){console.log("connecting native..."),null==e.hPort&&(e.hPort=e.connect(),null!=e.hPort&&(console.log("connect successful!"),e.extPoctInfo.bPCMgrInstall=!0))},onInit:function(){},checkUrlFW:function(t,n,o){var s={CMD:"QueryUrlFW"};s.URL=n,s.ID=t,null!=e.hPort&&e.hPort.postMessage(JSON.stringify(s))},sendMsgToHost:function(t,n,o){if("query_css"==t.cmd){if(null==e.hPort)return;if(e.isInPoct()&&n.tab&&-1!=n.tab.index){var s=(new Date).getTime()+"";e.queryCssResponseMap[s]=o;var r=JSON.parse(t.json);(a={}).CMD=t.cmd,a.FUNC_FLAG=s,a.URL=r.url,a.ID=n.tab.id,e.hPort.postMessage(JSON.stringify(a))}}else if("query_popupShow"==t.cmd)!function(t){if(null!=e.hPort){e.popupCallback=t;e.hPort.postMessage(JSON.stringify({CMD:"GetExtPoctStatus"}))}else t(e.extPoctInfo)}(o);else if("OpenQQPCTray"==t.cmd){if(null==e.hPort)return;(a={}).CMD=t.cmd,e.hPort.postMessage(JSON.stringify(a))}else if("OpenQMSetting"==t.cmd){if(null==e.hPort)return;(a={}).CMD=t.cmd,e.hPort.postMessage(JSON.stringify(a))}else if("get_defenseCount"==t.cmd)!function(t){if(null!=e.hPort){e.startUrlCallback=t;e.hPort.postMessage(JSON.stringify({CMD:"GetUrlStat"}))}}(o);else if("QueryUrlFW_popup"==t.cmd)!function(t,n){if(console.log("OnPopupQuery:",t),null!=e.hPort){var o={CMD:"QueryUrlFW"};o.URL=t.url,o.ID=t.id,o.ISPOP=!0,e.popupQueryCallback=n,e.hPort.postMessage(JSON.stringify(o))}}(t,o);else if("OpenAvSetting"==t.cmd){if(null==e.hPort)return;(a={}).CMD=t.cmd,e.hPort.postMessage(JSON.stringify(a))}else if("TrustURl"==t.cmd){if(null==e.hPort)return;(a={}).CMD=t.cmd,a.URL=t.url,e.hPort.postMessage(JSON.stringify(a))}else if("OpenRiskUrlLog"==t.cmd){if(null==e.hPort)return;var a;(a={}).CMD=t.cmd,e.hPort.postMessage(JSON.stringify(a))}},handleMsgFromNative:function(t){var n=t[0];if("IsMatchJsRule"==n.CMD)n.REQUESTID in e.jsQueryMap?delete e.jsQueryMap[n.REQUESTID]:e.jsQueryMap[n.REQUESTID]=n.BLOCK;else if("GetBasicInfoData"==n.CMD){var o=n.BASICDATA;e.basicInfo=JSON.parse(o)}else if("QueryUrlFW"==n.CMD){var s=n.URL;if("4"==n.URLTP&&chrome.action.setIcon({path:"../images/Warning.png",tabId:parseInt(n.ID)}),""!=s&&"3"==n.URLTP){var r={evilMainClass:n.EVILMAINCLASS,evilType:n.EVILTP};console.log("isPopupQuery,pageSafe=",r),11==r.evilType?chrome.action.setIcon({path:"../images/safe.png",tabId:parseInt(n.ID)}):2==r.evilType?chrome.action.setIcon({path:"../images/Danger.png",tabId:parseInt(n.ID)}):r.evilMainClass>=1&&r.evilMainClass<=8&&chrome.action.setIcon({path:"../images/Warning.png",tabId:parseInt(n.ID)}),e.popupQueryCallback(r)}""!=s&&"2"==n.URLTP&&""!=n.DFDURL?(chrome.tabs.update(parseInt(n.ID),{url:n.DFDURL}),console.log("setIcon......"),chrome.action.setIcon({path:"../images/Danger.png",tabId:parseInt(n.ID)}),function(t){if(null!=e.hPort){var n={CMD:"LogRiskURl"};n.URL=t.URL,n.EVILMAINCLASS=t.EVILMAINCLASS,e.hPort.postMessage(JSON.stringify(n))}}(n)):"1"==n.URLTP?(console.log("TPID:",n.URLTP),console.log("URL:",n.URL),chrome.action.setIcon({path:"../images/safe.png",tabId:parseInt(n.ID)})):"0"==n.URLTP&&(n.URL.includes(e.safeUrl)?chrome.action.setIcon({path:"../images/Danger.png",tabId:parseInt(n.ID)}):n.URL.includes("qq")&&chrome.action.setIcon({path:"../images/safe.png",tabId:parseInt(n.ID)}))}else if("GetExtPoctStatus"==n.CMD)e.extPoctInfo.bExtPoctSwitch="true"==n.EXTPOCTSWITCH,e.extPoctInfo.bTrayRunning="true"==n.TRAYRUNNING,e.extPoctInfo.bPCMgrInstall="true"==n.QQPCMGRINST,n.SAFEURL&&(e.safeUrl=n.SAFEURL),chrome.storage.sync.set({safeUrl:e.safeUrl},(()=>console.log("**********safeUrl:************",e.safeUrl))),console.log("safeUrlStr:",e.safeUrl),e.popupCallback&&e.popupCallback(e.extPoctInfo);else if("query_css"==n.CMD){var a=n.RETURNSTR;""!=a?(e.queryCssResponseMap[n.FUNC_FLAG]({selectors:a}),delete e.queryCssResponseMap[n.FUNC_FLAG]):delete e.queryCssResponseMap[n.FUNC_FLAG]}else"GetUrlStat"==n.CMD&&(console.log("******************GetUrlStat******************",n),e.defenseCount.todayRiskCount=n.TODAYRISKCOUNT,e.defenseCount.todayCount=n.TODAYCOUNT,e.defenseCount.totalRiskCount=n.TOTALRISKCOUNT,e.startUrlCallback&&e.startUrlCallback(e.defenseCount))}};e.init(),chrome.runtime.onMessage.addListener((function(t,n,o){return console.log("request:",t),console.log("sender:",n),console.log("sendResponse:",o),e.sendMsgToHost(t,n,o),!0})),chrome.tabs.onUpdated.addListener((function(t,n,o){if("loading"==n.status){if(!o.url)return;e.checkUrlFW(o.id,o.url,2)}}))})();